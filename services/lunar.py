from datetime import datetime
import ephem
from math import floor
import pytz

def get_moon_day() -> int:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ª—É–Ω–Ω—ã–π –¥–µ–Ω—å"""
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    tz = pytz.timezone('Europe/Moscow')
    now = datetime.now(tz)
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç Observer –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞—Ü–∏–∏ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä –†–æ—Å—Å–∏–∏)
    obs = ephem.Observer()
    obs.lat = '55.7522'  # –®–∏—Ä–æ—Ç–∞ –ú–æ—Å–∫–≤—ã
    obs.long = '37.6156'  # –î–æ–ª–≥–æ—Ç–∞ –ú–æ—Å–∫–≤—ã
    obs.date = now
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –Ω–æ–≤–æ–ª—É–Ω–∏—è
    previous_new_moon = ephem.previous_new_moon(now.strftime('%Y/%m/%d'))
    
    # –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π, –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å –Ω–æ–≤–æ–ª—É–Ω–∏—è
    moon_day = int(now.date().strftime('%d')) - int(previous_new_moon.datetime().strftime('%d'))
    if moon_day <= 0:
        moon_day += 30
    
    return moon_day

def get_moon_phase() -> float:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É –ª—É–Ω—ã (0-1)"""
    moon = ephem.Moon()
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    tz = pytz.timezone('Europe/Moscow')
    now = datetime.now(tz)
    moon.compute(now)
    return moon.phase / 100.0

def get_moon_phase_name(phase: float) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã –ª—É–Ω—ã"""
    if phase < 0.05:
        return "üåë –ù–æ–≤–æ–ª—É–Ω–∏–µ"
    elif phase < 0.25:
        return "üåí –†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞"
    elif phase < 0.45:
        return "üåì –ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å"
    elif phase < 0.55:
        return "üåï –ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ"
    elif phase < 0.75:
        return "üåó –ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å"
    elif phase < 0.95:
        return "üåò –£–±—ã–≤–∞—é—â–∞—è –ª—É–Ω–∞"
    else:
        return "üåë –ù–æ–≤–æ–ª—É–Ω–∏–µ"

def get_moon_sign() -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª—É–Ω–∞"""
    moon = ephem.Moon()
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    tz = pytz.timezone('Europe/Moscow')
    now = datetime.now(tz)
    moon.compute(now)
    
    # –ü–æ–ª—É—á–∞–µ–º —ç–∫–ª–∏–ø—Ç–∏—á–µ—Å–∫—É—é –¥–æ–ª–≥–æ—Ç—É
    ecl_long = float(moon.hlong) * 180 / ephem.pi
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞
    zodiac_signs = [
        "‚ôàÔ∏è –û–≤–µ–Ω", "‚ôâÔ∏è –¢–µ–ª–µ—Ü", "‚ôäÔ∏è –ë–ª–∏–∑–Ω–µ—Ü—ã", "‚ôãÔ∏è –†–∞–∫",
        "‚ôåÔ∏è –õ–µ–≤", "‚ôçÔ∏è –î–µ–≤–∞", "‚ôéÔ∏è –í–µ—Å—ã", "‚ôèÔ∏è –°–∫–æ—Ä–ø–∏–æ–Ω",
        "‚ôêÔ∏è –°—Ç—Ä–µ–ª–µ—Ü", "‚ôëÔ∏è –ö–æ–∑–µ—Ä–æ–≥", "‚ôíÔ∏è –í–æ–¥–æ–ª–µ–π", "‚ôìÔ∏è –†—ã–±—ã"
    ]
    
    sign_index = int(ecl_long / 30)
    return zodiac_signs[sign_index % 12]

def get_lunar_recommendations(phase_name: str) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã –ª—É–Ω—ã"""
    recommendations = {
        "üåë –ù–æ–≤–æ–ª—É–Ω–∏–µ": (
            "‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π\n"
            "‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–ª–∞–Ω—ã –∏ —Å—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏\n"
            "‚Ä¢ –•–æ—Ä–æ—à–æ –Ω–∞—á–∏–Ω–∞—Ç—å –¥–∏–µ—Ç—É –∏–ª–∏ –Ω–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏"
        ),
        "üåí –†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞": (
            "‚Ä¢ –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ä–æ—Å—Ç–∞ –∏ —Ä–∞–∑–≤–∏—Ç–∏—è\n"
            "‚Ä¢ –ù–∞—á–∏–Ω–∞–π—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚Ä¢ –•–æ—Ä–æ—à–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π"
        ),
        "üåì –ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å": (
            "‚Ä¢ –í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π\n"
            "‚Ä¢ –ü—Ä–µ–æ–¥–æ–ª–µ–≤–∞–π—Ç–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è\n"
            "‚Ä¢ –•–æ—Ä–æ—à–æ –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π"
        ),
        "üåï –ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ": (
            "‚Ä¢ –ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —ç–º–æ—Ü–∏–π\n"
            "‚Ä¢ –ó–∞–≤–µ—Ä—à–∞–π—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–µ–ª–∞\n"
            "‚Ä¢ –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã"
        ),
        "üåó –ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å": (
            "‚Ä¢ –í—Ä–µ–º—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤\n"
            "‚Ä¢ –•–æ—Ä–æ—à–æ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è\n"
            "‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ –≤–∞–∂–Ω—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π"
        ),
        "üåò –£–±—ã–≤–∞—é—â–∞—è –ª—É–Ω–∞": (
            "‚Ä¢ –ó–∞–≤–µ—Ä—à–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚Ä¢ –•–æ—Ä–æ—à–æ –¥–ª—è –æ—á–∏—â–µ–Ω–∏—è –∏ –æ—Ç–¥—ã—Ö–∞\n"
            "‚Ä¢ –ò–∑–±–∞–≤–ª—è–π—Ç–µ—Å—å –æ—Ç –Ω–µ–Ω—É–∂–Ω–æ–≥–æ"
        )
    }
    return recommendations.get(phase_name, "–ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ —Å–≤–æ–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.")

def get_lunar_text() -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ª—É–Ω—ã"""
    try:
        phase = get_moon_phase()
        phase_name = get_moon_phase_name(phase)
        moon_day = get_moon_day()
        moon_sign = get_moon_sign()
        recommendations = get_lunar_recommendations(phase_name)
        
        text = (
            f"*–§–∞–∑–∞ –ª—É–Ω—ã:* {phase_name}\n"
            f"*–õ—É–Ω–Ω—ã–π –¥–µ–Ω—å:* {moon_day}\n"
            f"*–õ—É–Ω–∞ –≤ –∑–Ω–∞–∫–µ:* {moon_sign}\n\n"
            f"*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*\n{recommendations}"
        )
        
        return text
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª—É–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {str(e)}"