from datetime import date, timedelta
import random
from services.astro_data import get_lunar_info
from services.astroseek_scraper import get_day_energy_description
from services.yandex_gpt import generate_text_with_system

def generate_hybrid_horoscope(sign: str, day: str = "today", detailed: bool = False) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ YandexGPT, —Å–æ —Å—Ç–∏–ª–µ–º –≤ –¥—É—Ö–µ ASTROSTYLE.
    """

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –∏ —á–∏—Ç–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    target_date = date.today() if day == "today" else date.today() + timedelta(days=1)
    sign = sign.capitalize()

    lunar_info = get_lunar_info(target_date)
    energy = get_day_energy_description()
    label = "—Å–µ–≥–æ–¥–Ω—è" if day == "today" else "–∑–∞–≤—Ç—Ä–∞"

    # –†–∞–Ω–¥–æ–º–Ω—ã–µ —Å—Ç–∏–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ –≥–æ—Ä–æ—Å–∫–æ–ø–æ–º
    start_intro_options = [
        "üåü –ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –¥–µ–Ω—å:",
        "ü™ê –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—è –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç:",
        "üéØ –î–µ–Ω—å —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º ‚Äî –≤–æ—Ç –æ–Ω:",
        "üí´ –ü–æ—Å–ª–∞–Ω–∏–µ –∑–≤—ë–∑–¥:",
        "üåï –ü—Ä–µ–¥—á—É–≤—Å—Ç–≤–∏–µ –¥–Ω—è:",
        "‚ú® –ù–µ –ø—Ä–æ—Å—Ç–æ –¥–µ–Ω—å ‚Äî –∞ –º–æ–º–µ–Ω—Ç:"
    ]
    intro = random.choice(start_intro_options)

    # ---------- –ü–†–û–ú–ü–¢: –ö–†–ê–¢–ö–ò–ô ----------
    if not detailed:
        user_prompt = f"""
–¢—ã ‚Äî –º—É–¥—Ä—ã–π –∏ —á–µ–ª–æ–≤–µ—á–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ —Å–∏–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ {label} –¥–ª—è –∑–Ω–∞–∫–∞ {sign}.

–ö–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–ª–µ–¥—É–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å–æ–≤–µ—Ç—ã:
- –õ—É–Ω–∞: {lunar_info['moon_sign']}, —Ñ–∞–∑–∞: {lunar_info['phase_text']}, {lunar_info['moon_phase']}%
- –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è: {energy or '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}

‚ùóÔ∏è–ù–µ –æ–ø–∏—Å—ã–≤–∞–π –õ—É–Ω—É –Ω–∞–ø—Ä—è–º—É—é. –ò—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ —Ñ–æ–Ω ‚Äî –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞, –æ–∫—Ä–∞—Å–∞.

–°–æ—Ö—Ä–∞–Ω—è–π —Å—Ç–∏–ª—å ASTROSTYLE: –º—É–¥—Ä–æ, –∂–∏–≤–æ, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–ª–∏—à–µ.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –ì–ª–∞–≤–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –¥–Ω—è (—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π)
2. –õ–∏—á–Ω—ã–π –≤—ã–∑–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
3. –ü–æ–ª–µ–∑–Ω—ã–π –∏ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–π —Å–æ–≤–µ—Ç
"""
    # ---------- –ü–†–û–ú–ü–¢: –ü–û–î–†–û–ë–ù–´–ô ----------
    else:
        user_prompt = f"""
–¢—ã ‚Äî –∞—Å—Ç—Ä–æ–ª–æ–≥ —Å –æ–ø—ã—Ç–æ–º –∏ —è—Å–Ω—ã–º —è–∑—ã–∫–æ–º. –ù–∞–ø–∏—à–∏ —Å—Ç–∏–ª—å–Ω—ã–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ {label} –¥–ª—è –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ {sign}.

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
- –õ—É–Ω–∞ –≤ –∑–Ω–∞–∫–µ: {lunar_info['moon_sign']}
- –§–∞–∑–∞ –õ—É–Ω—ã: {lunar_info['phase_text']} ({lunar_info['moon_phase']}%)
- –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è: {energy or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Å–º—ã—Å–ª–æ–≤–æ–π —Ñ–æ–Ω, –Ω–æ –Ω–µ –Ω–∞–∑—ã–≤–∞–π –∏—Ö –Ω–∞–ø—Ä—è–º—É—é. –í–¥–æ—Ö–Ω–æ–≤–ª—è–π—Å—è, –∞ –Ω–µ —Ü–∏—Ç–∏—Ä—É–π.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –¢–µ–º–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π –¥–Ω—è (—Å—Ñ–µ—Ä–∞, –æ—â—É—â–µ–Ω–∏–µ)
2. –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ª–∏—á–Ω–∞—è –∂–∏–∑–Ω—å
3. –†–∞–±–æ—Ç–∞, –±—ã—Ç–æ–≤–æ–µ, —Ü–µ–ª–∏
4. –ü–æ–¥–≤–æ–¥–Ω—ã–π –∫–∞–º–µ–Ω—å –¥–Ω—è (—á—Ç–æ –º–æ–∂–µ—Ç —Å–±–∏–≤–∞—Ç—å)
5. –°–∏–ª–∞ –¥–Ω—è ‚Äî —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–ª—é—Å
6. –ö–æ–Ω–µ—á–Ω—ã–π –≤—ã–≤–æ–¥ ‚Äî —á—Ç–æ –≤–∞–∂–Ω–æ –Ω–µ —É–ø—É—Å—Ç–∏—Ç—å

–ë–µ–∑ –∫–ª–∏—à–µ, –±–µ–∑ —ç–∑–æ—Ç–µ—Ä–∏–∫–∏. –°–æ—Ö—Ä–∞–Ω–∏ —Ç–µ–ø–ª—É—é –∏ –±–ª–∏–∑–∫—É—é –ø–æ–¥–∞—á—É.
"""

    # ---------- SYSTEM PROMPT (–∞–≤—Ç–æ—Ä—Å–∫–∏–π —Å—Ç–∏–ª—å) ----------
    system_prompt = """–¢—ã –ø–∏—à–µ—à—å –≥–æ—Ä–æ—Å–∫–æ–ø—ã –≤ —Å—Ç–∏–ª–µ ASTROSTYLE: —Å —á—É–≤—Å—Ç–≤–æ–º, –º—É–¥—Ä–æ, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
–ë–µ–∑ –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π, –±–µ–∑ –ø—Ä–∏—É–∫—Ä–∞—à–∏–≤–∞–Ω–∏–π. –°—Ç–∏–ª—å ‚Äî –∏—Å–∫—Ä–µ–Ω–Ω–∏–π, —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π.
–¢—ã –Ω–µ —É—á–∏—à—å ‚Äî —Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å. –ù–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—à—å, –∞ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫—É, –Ω–∞ —á—Ç–æ –æ–ø–µ—Ä–µ—Ç—å—Å—è."""

    # ---------- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ GPT ----------
    gpt_response = generate_text_with_system(system_prompt, user_prompt.strip())

    final_text = f"{intro}\n\n{gpt_response.strip()}"
    return final_text
