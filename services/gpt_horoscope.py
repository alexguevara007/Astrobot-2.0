def generate_horoscope(sign: str, day: str = "today", detailed: bool = False):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞
    :param sign: –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
    :param day: –î–µ–Ω—å (today/tomorrow)
    :param detailed: –ü–æ–¥—Ä–æ–±–Ω—ã–π –∏–ª–∏ –∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
    :return: –¢–µ–∫—Å—Ç –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    """
    try:
        today = date.today()
        target = today if day == "today" else today + timedelta(days=1)
        date_str = str(target)
        sign = sign.lower()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cache = load_cache()
        cache_key = f"{'detailed' if detailed else 'brief'}_{sign}_{day}"
        
        if sign in cache and cache_key in cache[sign] and cache[sign][cache_key]["date"] == date_str:
            logger.info(f"–í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è {sign} –Ω–∞ {date_str}")
            return cache[sign][cache_key]["text"]

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —É—á–µ—Ç–æ–º –¥–Ω—è
        system_prompt = f"""–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥ —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏. 
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ—Å—Ç–∞–≤–∏—Ç—å {'–ø–æ–¥—Ä–æ–±–Ω—ã–π' if detailed else '–∫—Ä–∞—Ç–∫–∏–π'} –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ {'—Å–µ–≥–æ–¥–Ω—è' if day == 'today' else '–∑–∞–≤—Ç—Ä–∞'}.
        
        –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞:
        - –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        - {'–§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–æ–º–µ–Ω—Ç–µ –∏ –±–ª–∏–∂–∞–π—à–∏—Ö —á–∞—Å–∞—Ö' if day == 'today' else '–û–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∫ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–º —Å–æ–±—ã—Ç–∏—è–º'}
        - –£—á–∏—Ç—ã–≤–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –∑–Ω–∞–∫–∞ –∏ –µ–≥–æ —Å—Ç–∏—Ö–∏—é
        - –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
        - –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç–æ–Ω
        """

        # –í—ã–±–æ—Ä –ø—Ä–æ–º–ø—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –∏ —Ñ–æ—Ä–º–∞—Ç–∞
        if detailed:
            if day == "today":
                user_prompt = f"""–°–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è {sign.capitalize()}.

                –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞:
                1. üåü –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–Ω—è –∏ —Ç–µ–∫—É—â–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞
                2. ‚ù§Ô∏è –õ–∏—á–Ω–∞—è –∂–∏–∑–Ω—å –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
                3. üíº –ö–∞—Ä—å–µ—Ä–∞ (–≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è)
                4. üè• –ó–¥–æ—Ä–æ–≤—å–µ (–Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ)
                5. üí° –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
                6. üé® –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —Ç–∞–ª–∏—Å–º–∞–Ω—ã
                7. ‚è∞ –õ—É—á—à–∏–µ —á–∞—Å—ã –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–µ–ª —Å–µ–≥–æ–¥–Ω—è
                8. üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–Ω—è
                9. üéØ –¢–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
                10. üë• –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—â–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è"""
            else:
                user_prompt = f"""–°–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –¥–ª—è {sign.capitalize()}.

                –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞:
                1. üåü –û–±—â–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å—Ç–æ—è—â–µ–≥–æ –¥–Ω—è
                2. ‚ù§Ô∏è –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –≤ –ª–∏—á–Ω–æ–π –∂–∏–∑–Ω–∏ (—á—Ç–æ –≥–æ—Ç–æ–≤–∏—Ç –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å)
                3. üíº –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (–Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ)
                4. üè• –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–¥–æ—Ä–æ–≤—å—é –Ω–∞ –∑–∞–≤—Ç—Ä–∞
                5. üí° –°–æ–≤–µ—Ç—ã –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º—É –¥–Ω—é
                6. üé® –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã
                7. ‚è∞ –í–∞–∂–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è
                8. üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
                9. üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è
                10. üë• –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ª—é–¥—å–º–∏"""
        else:
            if day == "today":
                user_prompt = f"""–°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è {sign.capitalize()}.

                –¢—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞:
                1. üåü –ì–ª–∞–≤–Ω–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
                2. üí° –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Å–æ–≤–µ—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                3. ‚è∞ –õ—É—á—à–∏–µ —á–∞—Å—ã –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–µ–ª

                –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–æ–º–µ–Ω—Ç–µ –∏ –±–ª–∏–∂–∞–π—à–∏—Ö —á–∞—Å–∞—Ö."""
            else:
                user_prompt = f"""–°–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –¥–ª—è {sign.capitalize()}.

                –¢—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞:
                1. üåü –ß—Ç–æ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å –æ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º –¥–Ω–µ
                2. üí° –ì–ª–∞–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ
                3. ‚è∞ –í–∞–∂–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è

                –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏."""

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ—Ä–æ—Å–∫–æ–ø
        logger.info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –¥–ª—è {sign} –Ω–∞ {date_str}")
        gpt_text = generate_text_with_system(system_prompt, user_prompt)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ª—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
        if detailed:
            try:
                lunar = get_lunar_text()
                full_text = f"{gpt_text}\n\nüåô –õ—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å:\n{lunar}"
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª—É–Ω–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è: {e}")
                full_text = gpt_text
        else:
            full_text = gpt_text

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        if sign not in cache:
            cache[sign] = {}
        cache[sign][cache_key] = {
            "date": date_str,
            "text": full_text
        }
        save_cache(cache)

        return full_text

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ—Ä–æ—Å–∫–æ–ø–∞: {e}", exc_info=True)
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ—Ä–æ—Å–∫–æ–ø–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
